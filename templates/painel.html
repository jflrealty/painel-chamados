<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Painel de Chamados</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa;padding:20px }
    .card-metric{min-width:180px}
    table td,table th{vertical-align:middle}
    .modal{display:none;position:fixed;top:10%;left:10%;width:80%;height:80%;background:#fff;padding:20px;border:2px solid #444;overflow:auto;z-index:1000}
  </style>
</head>
<body>
  <h2 class="mb-4">Painel de Chamados</h2>

  <!-- MÉTRICAS -->
  <div class="d-flex gap-4 mb-4 flex-wrap">
    {% for label, val, cls in [
        ('Total', metricas.total, ''),
        ('Em Atendimento', metricas.em_atendimento, 'text-warning'),
        ('Finalizados', metricas.finalizados, 'text-success'),
        ('Fora do SLA', metricas.fora_sla, 'text-danger'),
        ('Com Histórico', metricas.com_historico, 'text-info')] %}
      <div class="card card-metric shadow-sm">
        <div class="card-body text-center">
          <h5 class="card-title">{{label}}</h5>
          <p class="fs-4 {{cls}}">{{val}}</p>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- FILTROS -->
  <form method="get" action="/painel" class="row g-3 mb-4">
    <!-- Status -->
    <div class="col-md-2">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        {% for s in ['','Aberto','Em Atendimento','Finalizado','Cancelado'] %}
          <option value="{{s}}" {% if filtros.status==s %}selected{% endif %}>
            {{ 'Todos' if not s else s }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Responsável -->
    <div class="col-md-2">
      <label class="form-label">Responsável</label>
      <select name="responsavel" class="form-select">
        <option value="">Todos</option>
        {% for r in responsaveis %}
          <option value="{{r}}" {% if filtros.responsavel==r %}selected{% endif %}>{{r}}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Capturado por -->
    <div class="col-md-2">
      <label class="form-label">Capturado por</label>
      <select name="capturado" class="form-select">
        <option value="">Todos</option>
        {% for c in capturadores %}
          <option value="{{c}}" {% if filtros.capturado==c %}selected{% endif %}>{{c}}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Histórico -->
    <div class="col-md-2">
      <label class="form-label">Histórico</label>
      <select name="historico" class="form-select">
        <option value=""      {% if not filtros.historico %}selected{% endif %}>Todos</option>
        <option value="sim"   {% if filtros.historico=='sim' %}selected{% endif %}>Com histórico</option>
        <option value="nao"   {% if filtros.historico=='nao' %}selected{% endif %}>Sem histórico</option>
      </select>
    </div>

    <!-- Datas -->
    <div class="col-md-2">
      <label class="form-label">Início</label>
      <input type="date" name="data_ini" class="form-control" value="{{filtros.data_ini or ''}}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Fim</label>
      <input type="date" name="data_fim" class="form-control" value="{{filtros.data_fim or ''}}">
    </div>

    <div class="col-12 d-flex justify-content-end">
      <button class="btn btn-primary">Filtrar</button>
    </div>
  </form>

  <!-- TABELA -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped bg-white shadow-sm">
      <thead class="table-light">
        <tr>
          <th>ID</th><th>Tipo</th><th>Status</th><th>Responsável</th>
          <th>Capturado por</th><th>Abertura</th><th>Encerramento</th>
          <th>SLA</th><th class="text-center">Hist</th><th>Ação</th>
        </tr>
      </thead>
      <tbody>
      {% for ch in chamados %}
        <tr>
          <td>{{ch.id}}</td>
          <td>{{ch.tipo_ticket}}</td>
          <td>{{ch.status}}</td>
          <td>{{ch.responsavel}}</td>
          <td>{{ch.capturado_por}}</td>
          <td>{{ch.abertura}}</td>
          <td>{{ch.fechamento}}</td>
          <td class="text-center">
            {% if ch.sla.lower().startswith('fora') %}
              <span class="badge bg-danger">✘</span>
            {% elif ch.sla.lower().startswith('dentro') %}
              <span class="badge bg-success">✔</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td class="text-center">
            {% if ch.historico %}<span class="badge bg-info">⚡</span>{% else %}-{% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary"
                    onclick="verThread('{{ch.canal_id}}','{{ch.thread_ts}}')">
              Ver Thread
            </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <button class="btn btn-secondary" onclick="document.getElementById('modal').style.display='none'">Fechar</button>
    <div id="modal-content"></div>
  </div>

  <script>
    async function verThread(canal, ts){
      const form = new FormData();
      form.append("canal_id", canal);
      form.append("thread_ts", ts);

      const res  = await fetch("/thread", {method:"POST", body:form});
      const html = await res.text();
      document.getElementById("modal-content").innerHTML = html;
      document.getElementById("modal").style.display = "block";
    }
  </script>
</body>
</html>
