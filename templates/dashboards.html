<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboards</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8f9fa; padding:30px }
    canvas { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    h2 { margin-bottom: 30px; }
  </style>
</head>
<body>
  <div class="mb-4 d-flex gap-2">
    <a class="btn btn-outline-dark" href="/painel">üè† Home</a>
    <a class="btn btn-outline-primary" href="/dashboards">üìä Dashboards</a>
  </div>

  <h2>üìä Painel de Dashboards</h2>

  <div class="row g-4">
    <div class="col-md-6">
      <canvas id="chartStatus"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartResponsavel"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartTipo"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartSLACaptura"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartSLAEncerramento"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="chartMensal"></canvas>
    </div>
  </div>

  <script>
    const chamados = {{ dados | tojson | safe }};

    function agruparPor(lista, chave) {
      return lista.reduce((acc, item) => {
        const valor = item[chave] || '<n√£o definido>';
        acc[valor] = (acc[valor] || 0) + 1;
        return acc;
      }, {});
    }

    function calcularSLAMedio(inicioCampo, fimCampo) {
      let totalHoras = 0;
      let totalValidos = 0;

      chamados.forEach(c => {
        const ini = new Date(c[inicioCampo]);
        const fim = new Date(c[fimCampo]);
        if (!isNaN(ini) && !isNaN(fim)) {
          const horas = (fim - ini) / 3600000;
          if (horas >= 0 && horas < 999) {
            totalHoras += horas;
            totalValidos++;
          }
        }
      });
      return totalValidos ? (totalHoras / totalValidos).toFixed(2) : "0.00";
    }

    function agruparPorMes(dataCampo) {
      return chamados.reduce((acc, c) => {
        const dt = new Date(c[dataCampo]);
        if (!isNaN(dt)) {
          const mes = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
          acc[mes] = (acc[mes] || 0) + 1;
        }
        return acc;
      }, {});
    }

    function plotarBarChart(id, titulo, dados, cor = 'rgba(54, 162, 235, 0.7)') {
      const ctx = document.getElementById(id);
      const labels = Object.keys(dados);
      const values = Object.values(dados);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: titulo,
            data: values,
            backgroundColor: cor,
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, title: { display: true, text: titulo } },
          scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
      });
    }

    function plotarGaugeChart(id, titulo, valor) {
      const ctx = document.getElementById(id);
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['SLA M√©dio', 'Restante'],
          datasets: [{
            label: 'Horas',
            data: [valor, 24 - valor],
            backgroundColor: ['#198754', '#e9ecef'],
            borderWidth: 1,
            cutout: '80%'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: `${titulo}: ${valor}h` }
          }
        }
      });
    }

    // Gr√°ficos
    plotarBarChart('chartStatus', 'Volume por Status', agruparPor(chamados, 'status'));
    plotarBarChart('chartResponsavel', 'Volume por Respons√°vel', agruparPor(chamados, 'responsavel'));
    plotarBarChart('chartTipo', 'Volume por Tipo de Chamado', agruparPor(chamados, 'tipo_ticket'));
    plotarGaugeChart('chartSLACaptura', 'SLA M√©dio para Captura', parseFloat(calcularSLAMedio('abertura_raw', 'captura_raw')));
    plotarGaugeChart('chartSLAEncerramento', 'SLA M√©dio para Encerramento', parseFloat(calcularSLAMedio('abertura_raw', 'fechamento_raw')));
    plotarBarChart('chartMensal', 'Volume de Chamados por M√™s', agruparPorMes('abertura_raw'));
  </script>
</body>
</html>
