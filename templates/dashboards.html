<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboards</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
  body { background:#f8f9fa; padding:30px }
  canvas {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0,0,0,0.05);
  }
  h2 { margin-bottom: 30px; }

  .chart-card {
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .chart-container {
    width: 100%;
    max-width: 100%;
    height: 320px;
  }

  .card h6 {
    font-weight: 500;
    font-size: 0.9rem;
  }

  .card h5 {
    font-size: 1.4rem;
    font-weight: 600;
  }

  .card svg {
    margin-bottom: 4px;
  }

  .card-body svg {
    display: block;
    margin: 0 auto 6px auto;
  }

  #kpiCards .card {
    border: none;
    transition: all 0.2s ease-in-out;
  }

  #kpiCards .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  }

  /* üé® Transi√ß√£o suave de cores nos cards SLA */
  .card.bg-success,
  .card.bg-warning,
  .card.bg-danger {
    transition: background-color 0.3s ease;
  }

  /* üé® √çcones adaptando a cor com fundo */
  .card.bg-success svg,
  .card.bg-warning svg,
  .card.bg-danger svg {
    fill: white !important;
  }

  .card.bg-light svg {
    fill: gray !important;
  }
</style>
  
</head>
<body>
  <div class="mb-4 d-flex gap-2">
    <a class="btn btn-outline-dark" href="/painel">üè† Home</a>
    <a class="btn btn-outline-primary" href="/dashboards">üìä Dashboards</a>
  </div>

  <h2 class="fw-bold text-primary">üìä Painel de Chamados</h2>

 <div class="row g-3 mb-4" id="kpiCards">
  <div class="col-md-2">
    <div class="card text-white bg-primary shadow">
      <div class="card-body p-2 text-center">
        <div class="mb-1"><svg xmlns="http://www.w3.org/2000/svg" width="20" fill="white" class="bi bi-bar-chart" viewBox="0 0 16 16"><path d="M0 0h1v15h15v1H0V0zm10 10h1v3h-1v-3zM5 5h1v8H5V5zm5-3h1v11h-1V2z"/></svg></div>
        <h6 class="mb-0 small">Total</h6>
        <h5 id="kpiTotal">0</h5>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-warning shadow">
      <div class="card-body p-2 text-center">
        <div class="mb-1"><svg xmlns="http://www.w3.org/2000/svg" width="20" fill="black" class="bi bi-exclamation-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/><path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm.93-6.588-.82 4.001c-.07.34.16.587.44.587h.856c.28 0 .51-.247.44-.587l-.82-4.001c-.07-.34-.37-.34-.5 0z"/></svg></div>
        <h6 class="mb-0 small">Abertos</h6>
        <h5 id="kpiAbertos">0</h5>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-success shadow">
      <div class="card-body p-2 text-center">
        <div class="mb-1"><svg xmlns="http://www.w3.org/2000/svg" width="20" fill="white" class="bi bi-check-circle" viewBox="0 0 16 16"><path d="M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0zM0 8a8 8 0 1 0 16 0A8 8 0 0 0 0 8z"/><path d="M11.03 5.97a.75.75 0 0 0-1.06-1.06L7 7.94 6.03 6.97a.75.75 0 0 0-1.06 1.06l1.5 1.5a.75.75 0 0 0 1.06 0l3.5-3.5z"/></svg></div>
        <h6 class="mb-0 small">Fechados</h6>
        <h5 id="kpiFechados">0</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-light shadow" id="cardSlaCaptura">
      <div class="card-body p-2 text-center">
        <div class="mb-1"><svg xmlns="http://www.w3.org/2000/svg" width="20" fill="gray" class="bi bi-stopwatch" viewBox="0 0 16 16"><path d="M6.5.5a.5.5 0 0 1 .5.5v1h2V1a.5.5 0 0 1 1 0v1h1a.5.5 0 0 1 0 1h-.184A6.978 6.978 0 0 1 13 8a6.978 6.978 0 0 1-2.184 5H11a.5.5 0 0 1 0 1h-6a.5.5 0 0 1 0-1h.184A6.978 6.978 0 0 1 3 8a6.978 6.978 0 0 1 2.184-5H5a.5.5 0 0 1 0-1h1V1a.5.5 0 0 1 .5-.5zM8 14a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/><path d="M8 4a.5.5 0 0 1 .5.5v3.379l2.015 2.015a.5.5 0 0 1-.707.707L7.5 8.586V4.5A.5.5 0 0 1 8 4z"/></svg></div>
        <h6 class="mb-0 small">SLA M√©dio Captura</h6>
        <h5 id="kpiSlaCaptura">0.00h</h5>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-light shadow" id="cardSlaEncerramento">
      <div class="card-body p-2 text-center">
        <div class="mb-1"><svg xmlns="http://www.w3.org/2000/svg" width="20" fill="gray" class="bi bi-clock-history" viewBox="0 0 16 16"><path d="M8.515 3.879a.5.5 0 0 0-1.03 0v4.243l3.181 1.84a.5.5 0 1 0 .5-.866L8.515 8.121V3.879z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm0-1A7 7 0 1 1 8 1a7 7 0 0 1 0 14z"/></svg></div>
        <h6 class="mb-0 small">SLA M√©dio Encerramento</h6>
        <h5 id="kpiSlaEncerramento">0.00h</h5>
      </div>
    </div>
  </div>
</div>

  <!-- Filtros -->
  <form class="row g-2 mb-4" id="formFiltros">
    <div class="col-md-2">
      <label class="form-label">Data In√≠cio</label>
      <input type="date" id="filtroDataIni" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Fim</label>
      <input type="date" id="filtroDataFim" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Respons√°vel</label>
      <select id="filtroResponsavel" class="form-select">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Status</label>
      <select id="filtroStatus" class="form-select">
        <option value="">Todos</option>
        <option value="aberto">Aberto</option>
        <option value="em an√°lise">Em An√°lise</option>
        <option value="em atendimento">Em Atendimento</option>
        <option value="fechado">Fechado</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Tipo</label>
      <select id="filtroTipo" class="form-select">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
      <button type="submit" class="btn btn-primary">
      Atualizar Dashboards
      </button>
      <button onclick="limparFiltros()" class="btn btn-outline-secondary">
      Limpar Filtros
      </button>
    </div>
</div>
    
    </div>
  </form>

  <!-- Gr√°ficos -->
<div class="row g-4">
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartStatus"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartResponsavel"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartTipo"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartVendedor"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartMensal"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartSLACaptura"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartSLAEncerramento"></canvas></div>
  </div>
</div>
  <script>
  const chamadosOriginais = {{ dados | tojson | safe }};

  function agruparPor(lista, chave) {
    return lista.reduce((acc, item) => {
      const valor = item[chave] || '<n√£o definido>';
      acc[valor] = (acc[valor] || 0) + 1;
      return acc;
    }, {});
  }

function calcularSLAMedio(dados, inicioCampo, fimCampo) {
  let totalHoras = 0;
  let totalValidos = 0;

  dados.forEach(c => {
    const iniRaw = c[inicioCampo];
    const fimRaw = c[fimCampo];

    // Ignora registros ausentes
    if (!iniRaw || !fimRaw) return;

    const ini = new Date(iniRaw);
    const fim = new Date(fimRaw);

    // Valida as datas
    if (!(ini instanceof Date && !isNaN(ini)) || !(fim instanceof Date && !isNaN(fim))) return;

    const diffHoras = (fim - ini) / 3600000;

    // Ignora chamados com dura√ß√£o negativa ou muito fora do padr√£o (limite de 14 dias √∫teis)
    if (diffHoras >= 0 && diffHoras <= 48 * 7) {
      totalHoras += diffHoras;
      totalValidos++;
    }
  });

  console.log(`[DEBUG SLA] Campo: ${inicioCampo} ‚Üí ${fimCampo} | V√°lidos: ${totalValidos}`);
  return totalValidos ? (totalHoras / totalValidos).toFixed(2) : "0.00";
}
    
  function agruparPorMes(dados, campo) {
    return dados.reduce((acc, c) => {
      const dt = new Date(c[campo]);
      if (!isNaN(dt)) {
        const mes = dt.toLocaleDateString("pt-BR", { month: 'short', year: 'numeric' });
        acc[mes] = (acc[mes] || 0) + 1;
      }
      return acc;
    }, {});
  }

  function plotarBarChart(id, titulo, dados, cor = 'rgba(54, 162, 235, 0.7)') {
    const ctx = document.getElementById(id);
    const labels = Object.keys(dados);
    const values = Object.values(dados);
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: titulo,
          data: values,
          backgroundColor: cor,
          borderRadius: 6,
          barThickness: 30
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: titulo,
            font: { size: 18 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.parsed.y} chamados`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 0,
              font: { size: 12 }
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0,
              stepSize: 10,
              font: { size: 12 }
            }
          }
        }
      }
    });
  }

  function plotarGaugeChart(id, titulo, valor) {
    const ctx = document.getElementById(id);
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['SLA M√©dio', 'Restante'],
        datasets: [{
          data: [valor, 24 - valor],
          backgroundColor: ['#198754', '#e9ecef'],
          cutout: '75%',
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: `${titulo}: ${valor}h`,
            font: { size: 18 }
          }
        }
      }
    });
  }

  // ‚úÖ Muda cor do card com base no SLA
  function aplicarCorDinamicaSLA(cardId, valor) {
  const card = document.getElementById(cardId);
  const h = parseFloat(valor);

  // Limpa classes antigas do card
  card.className = "card shadow p-2 text-center";

  // Pega o elemento <h5> dentro do card (onde est√° o valor do SLA)
  const valorTexto = card.querySelector("h5");

  // Limpa classes de cor anteriores do texto
  valorTexto.classList.remove("text-white", "text-dark");

  // Aplica cores de acordo com o SLA
  if (h < 2) {
    card.classList.add("bg-success");
    valorTexto.classList.add("text-white");
  } else if (h < 6) {
    card.classList.add("bg-warning");
    valorTexto.classList.add("text-dark");
  } else {
    card.classList.add("bg-danger");
    valorTexto.classList.add("text-white");
  }
}
  // ‚úÖ Atualiza os KPIs
  function atualizarKPIs(dados) {
    const total = dados.length;
    const abertos = dados.filter(c => c.status === 'aberto').length;
    const fechados = dados.filter(c => c.status === 'fechado').length;
    const slaCaptura = calcularSLAMedio(dados, 'abertura_raw', 'captura_raw');
    const slaFechamento = calcularSLAMedio(dados, 'abertura_raw', 'fechamento_raw');

    document.getElementById('kpiTotal').textContent = total;
    document.getElementById('kpiAbertos').textContent = abertos;
    document.getElementById('kpiFechados').textContent = fechados;
    document.getElementById('kpiSlaCaptura').textContent = `${slaCaptura}h`;
    document.getElementById('kpiSlaEncerramento').textContent = `${slaFechamento}h`;

    aplicarCorDinamicaSLA('cardSlaCaptura', slaCaptura);
    aplicarCorDinamicaSLA('cardSlaEncerramento', slaFechamento);
  }

  function atualizarDashboards() {
    const ini = document.getElementById('filtroDataIni').value;
    const fim = document.getElementById('filtroDataFim').value;
    const resp = document.getElementById('filtroResponsavel').value;
    const status = document.getElementById('filtroStatus').value;
    const tipo = document.getElementById('filtroTipo').value;

    let dados = [...chamadosOriginais];

    if (ini) dados = dados.filter(c => new Date(c.abertura_raw) >= new Date(ini));
    if (fim) dados = dados.filter(c => new Date(c.abertura_raw) <= new Date(fim));
    if (resp) dados = dados.filter(c => c.responsavel === resp);
    if (status) dados = dados.filter(c => c.status === status);
    if (tipo) dados = dados.filter(c => c.tipo_ticket === tipo);

    document.querySelectorAll('canvas').forEach(c => c.replaceWith(c.cloneNode(true)));

    plotarBarChart('chartStatus', 'Volume por Status', agruparPor(dados, 'status'), 'rgba(75, 192, 192, 0.7)');
    plotarBarChart('chartResponsavel', 'Volume por Respons√°vel', agruparPor(dados, 'responsavel'), 'rgba(255, 99, 132, 0.7)');
    plotarBarChart('chartTipo', 'Volume por Tipo de Chamado', agruparPor(dados, 'tipo_ticket'), 'rgba(255, 206, 86, 0.7)');
    plotarBarChart('chartMensal', 'Volume de Chamados por M√™s', agruparPorMes(dados, 'abertura_raw'), 'rgba(153, 102, 255, 0.7)');
    plotarBarChart('chartVendedor', 'Volume por Vendedor', agruparPor(dados, 'solicitante'), 'rgba(255, 159, 64, 0.7)');
    plotarGaugeChart('chartSLACaptura', 'SLA M√©dio Captura', calcularSLAMedio(dados, 'abertura_raw', 'captura_raw'));
    plotarGaugeChart('chartSLAEncerramento', 'SLA M√©dio Fechamento', calcularSLAMedio(dados, 'abertura_raw', 'fechamento_raw'));

    atualizarKPIs(dados); // ‚úÖ Chamando fun√ß√£o corretamente
  }

  document.getElementById('formFiltros').addEventListener('submit', function(e) {
    e.preventDefault();
    atualizarDashboards();
  });

  // Atualiza na carga inicial
  atualizarDashboards();
</script>
</body>
</html>
