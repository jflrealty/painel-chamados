<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboards</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
  body { background:#f8f9fa; padding:30px }
  canvas {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0,0,0,0.05);
  }
  h2 { margin-bottom: 30px; }

  .chart-card {
    padding: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .chart-container {
    width: 100%;
    max-width: 100%;
    height: 320px;
  }
</style>
</head>
<body>
  <div class="mb-4 d-flex gap-2">
    <a class="btn btn-outline-dark" href="/painel">🏠 Home</a>
    <a class="btn btn-outline-primary" href="/dashboards">📊 Dashboards</a>
  </div>

  <h2 class="fw-bold text-primary">📊 Painel Gerencial de Chamados</h2>

  <!-- Filtros -->
  <form class="row g-2 mb-4" id="formFiltros">
    <div class="col-md-2">
      <label class="form-label">Data Início</label>
      <input type="date" id="filtroDataIni" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Data Fim</label>
      <input type="date" id="filtroDataFim" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Responsável</label>
      <select id="filtroResponsavel" class="form-select">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Status</label>
      <select id="filtroStatus" class="form-select">
        <option value="">Todos</option>
        <option value="aberto">Aberto</option>
        <option value="em análise">Em Análise</option>
        <option value="em atendimento">Em Atendimento</option>
        <option value="fechado">Fechado</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Tipo</label>
      <select id="filtroTipo" class="form-select">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">🔄 Atualizar Dashboards</button>
    </div>
  </form>

  <!-- Gráficos -->
<div class="row g-4">
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartStatus"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartResponsavel"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartTipo"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartVendedor"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartMensal"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartSLACaptura"></canvas></div>
  </div>
  <div class="col-md-6 chart-card">
    <div class="chart-container"><canvas id="chartSLAEncerramento"></canvas></div>
  </div>
</div>
  <script>
    const chamadosOriginais = {{ dados | tojson | safe }};

    function agruparPor(lista, chave) {
      return lista.reduce((acc, item) => {
        const valor = item[chave] || '<não definido>';
        acc[valor] = (acc[valor] || 0) + 1;
        return acc;
      }, {});
    }

    function calcularSLAMedio(dados, inicioCampo, fimCampo) {
      let totalHoras = 0;
      let totalValidos = 0;
      dados.forEach(c => {
        const ini = new Date(c[inicioCampo]);
        const fim = new Date(c[fimCampo]);
        if (!isNaN(ini) && !isNaN(fim)) {
          const horas = (fim - ini) / 3600000;
          if (horas >= 0 && horas < 999) {
            totalHoras += horas;
            totalValidos++;
          }
        }
      });
      return totalValidos ? (totalHoras / totalValidos).toFixed(2) : "0.00";
    }

    function agruparPorMes(dados, campo) {
      return dados.reduce((acc, c) => {
        const dt = new Date(c[campo]);
        if (!isNaN(dt)) {
          const mes = dt.toLocaleDateString("pt-BR", { month: 'short', year: 'numeric' });
          acc[mes] = (acc[mes] || 0) + 1;
        }
        return acc;
      }, {});
    }

    function plotarBarChart(id, titulo, dados, cor = 'rgba(54, 162, 235, 0.7)') {
  const ctx = document.getElementById(id);
  const labels = Object.keys(dados);
  const values = Object.values(dados);
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: titulo,
        data: values,
        backgroundColor: cor,
        borderRadius: 6,
        barThickness: 30
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: titulo,
          font: { size: 18 }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.parsed.y} chamados`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 0,
            font: { size: 12 }
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0,
            stepSize: 10,
            font: { size: 12 }
          }
        }
      }
    }
  });
}

    function plotarGaugeChart(id, titulo, valor) {
  const ctx = document.getElementById(id);
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['SLA Médio', 'Restante'],
      datasets: [{
        data: [valor, 24 - valor],
        backgroundColor: ['#198754', '#e9ecef'],
        cutout: '75%',
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: `${titulo}: ${valor}h`,
          font: { size: 18 }
        }
      }
    }
  });
}
    function atualizarDashboards() {
      const ini = document.getElementById('filtroDataIni').value;
      const fim = document.getElementById('filtroDataFim').value;
      const resp = document.getElementById('filtroResponsavel').value;
      const status = document.getElementById('filtroStatus').value;
      const tipo = document.getElementById('filtroTipo').value;

      let dados = [...chamadosOriginais];

      if (ini) dados = dados.filter(c => new Date(c.abertura_raw) >= new Date(ini));
      if (fim) dados = dados.filter(c => new Date(c.abertura_raw) <= new Date(fim));
      if (resp) dados = dados.filter(c => c.responsavel === resp);
      if (status) dados = dados.filter(c => c.status === status);
      if (tipo) dados = dados.filter(c => c.tipo_ticket === tipo);

      document.querySelectorAll('canvas').forEach(c => c.replaceWith(c.cloneNode(true)));

      plotarBarChart('chartStatus', 'Volume por Status', agruparPor(dados, 'status'), 'rgba(75, 192, 192, 0.7)');
      plotarBarChart('chartResponsavel', 'Volume por Responsável', agruparPor(dados, 'responsavel'), 'rgba(255, 99, 132, 0.7)');
      plotarBarChart('chartTipo', 'Volume por Tipo de Chamado', agruparPor(dados, 'tipo_ticket'), 'rgba(255, 206, 86, 0.7)');
      plotarBarChart('chartMensal', 'Volume de Chamados por Mês', agruparPorMes(dados, 'abertura_raw'), 'rgba(153, 102, 255, 0.7)');
      plotarBarChart('chartVendedor', 'Volume por Vendedor', agruparPor(dados, 'solicitante'), 'rgba(255, 159, 64, 0.7)');
    }

    document.getElementById('formFiltros').addEventListener('submit', e => {
      e.preventDefault();
      atualizarDashboards();
    });

    // Popular selects
    const selectResp = document.getElementById('filtroResponsavel');
    const selectTipo = document.getElementById('filtroTipo');
    const responsaveis = [...new Set(chamadosOriginais.map(c => c.responsavel))].sort();
    const tipos = [...new Set(chamadosOriginais.map(c => c.tipo_ticket))].sort();

    responsaveis.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      selectResp.appendChild(opt);
    });

    tipos.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      selectTipo.appendChild(opt);
    });

    atualizarDashboards();
  </script>
</body>
</html>
